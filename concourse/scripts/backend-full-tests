#!/bin/bash
set -e

python_version=${1:-3.6.14}
database=${2:-all}

source "$HOME/.bashrc"
pyenv shell "$python_version"

"$(dirname $0)"/install_docker
source "$(dirname $0)/docker-lib.sh"
start_docker

"$(dirname $0)"/install_backend_packages
"$(dirname $0)"/create_backend_dirs backend/test_storage_dir
cd backend
pip install $(for r in requirements*.txt; do echo "-r $r"; done)
python setup.py develop
docker-compose up -d
pytest --database="$database"
